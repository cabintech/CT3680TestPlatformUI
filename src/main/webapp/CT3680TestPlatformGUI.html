<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CT3680 Test</title>
    <link rel="stylesheet" type="text/css" href="testPlatform.css"/>
</head>
<body>
	<main>
		<div id="startPage" class="currentTab">
			<h2>Insert the next module, then click the button below:</h2><br>
			<div id="alignmentWrapper">
				<button id="btnStart">Start<br>Testing Procedure</button><br>
				<span id="cbList">
					<span class="checkSpan">
						<input type="checkbox" id="cbAddToStock" name="cbAddToStock" class="cb">
			        	<label for="cbAddToStock">Add to stock management system if all tests pass</label>
			        </span><br>
			        <span class="checkSpan">
						<input type="checkbox" id="cbInitNewMod" name="cbInitNewMod" class="cb">
			        	<label for="cbInitNewMod">Initialize new module</label>
			        </span><br>
			        <span class="checkSpan">
						<input type="checkbox" id="cbUpdateResults" name="cbUpdateResults" class="cb">
			        	<label for="cbUpdateResults">Update test results</label>
			        </span>
				</span><br>
			</div>
		</div>
		<div id="confirmRetestPage" class="hiddenTab">
			<h2>Module already exists in database. Do you wish to re-test?</h2><br>
			<span>
				<button id="backToStart">No, back to<br>Start screen</button>
				<button id="proceedWithTesting">Proceed with<br>Testing</button>
			</span>
		</div>
		<div id="progressPage" class="hiddenTab">
			<h2>Testing in progress, please wait....</h2><br>
			<canvas id="canvas"></canvas><br/>
			<div id="progress">Example text</div>
			<button id="btnCancel">Cancel</button>
		</div>
		<div id="resultsPage" class="hiddenTab">
			<h2>Testing Complete</h2><br>
			<span>
				<span id="statusLbl"><b>Status:</b></span>
				<button id="status">Pass</button>
			</span><br>
			<button id="nextBtn">Next</button>
		</div>
	</main>
</body>
<script
  src="https://code.jquery.com/jquery-3.6.1.min.js"
  integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
  crossorigin="anonymous">
</script>
<script>
	//set up canvas for progress indicator
	var canvas= document.getElementById("canvas");
	var ctx= canvas.getContext("2d");
	const centerX = canvas.width / 2;
	const centerY = canvas.height / 2;

	//draw the outline
	function drawCircle() {
		//clear the canvas
		ctx.clearRect(0,0,canvas.width,canvas.height);
		
		var radius = 51;
		var startAngle = 0;
		var endAngle = Math.PI * 2;
	    ctx.beginPath();
	    ctx.lineCap="square";
	    ctx.strokeStyle="black";
	    ctx.arc(centerX, centerY, radius, startAngle, endAngle, true);
	    ctx.stroke();
	}

	//wait for a specified time in miliseconds
	function sleep(ms) {
		return new Promise(resolve => setTimeout(resolve, ms));
	}

	//fill the circle to indicate progress status
	//will be updated to take an argument indicating percent complete
	//currently hardcoded to update every 50 ms until reaching 100% progress after 5 seconds
	async function drawProgress() {
		var radius = 50;
		var startAngle = 0 - (Math.PI / 2);
	    ctx.beginPath();
	    ctx.lineCap="square";
	    ctx.strokeStyle="black";
		for (let i=0; i<=100; i++) {
			//calculate angle based on percent complete (0-100)
			var endAngle = (Math.PI * 2)*(i/100) - (Math.PI / 2);
			
			//draw and fill the arc
			ctx.moveTo(centerX, centerY);
			ctx.arc(centerX, centerY, radius, startAngle, endAngle, false);
			ctx.closePath();
			ctx.fillStyle = 'blue';
			ctx.fill();
			
			//update the label to display % complete
			$("#progress").text(i + "%");
			//wait 50 ms
			await sleep(50);
		}
		
		//hide this div and make the results div visble
		$(".currentTab").toggleClass("hiddenTab");
		$(".currentTab").toggleClass("currentTab");
		$("#resultsPage").toggleClass("hiddenTab");
		$("#resultsPage").toggleClass("currentTab");
	}
	
	//define click function for Start button
	$("#btnStart").click(function(){
		//currently hardcoded to ignore the confirmRetest page, will add this to the screenflow later
		
		//hide this div and make the progress div visble
		$(".currentTab").toggleClass("hiddenTab");
		$(".currentTab").toggleClass("currentTab");
		$("#progressPage").toggleClass("hiddenTab");
		$("#progressPage").toggleClass("currentTab");
		
		//draw the outline for the progress indicator
	    drawCircle();
		//fill in the progress indicator (currently hardcoded)
		drawProgress();
		
		//make a call to TestCom servlet
//		$.ajax({
//			url: "TestCom",
//			type: "GET",
//			contentType: "text",
//			success: function(result) {
//				//no need to do anything, this is just to test communication between the PC and uC, will be replaced later
//			},
//			error: function(xhr) {
//				alert("Error: HTTP status " + xhr.status);
//			}
//		});
		$.ajax({
			url: "TestDiagnostics",
			type: "GET",
			contentType: "text",
			success: function(result) {
				//no need to do anything, this is just to test communication between the PC and uC, will be replaced later
			},
			error: function(xhr) {
				alert("Error: HTTP status " + xhr.status);
			}
		});
    });
	
	//define click function for Next button
	$("#nextBtn").click(function(){
		//hide this div and make the start div visble
		$(".currentTab").toggleClass("hiddenTab");
		$(".currentTab").toggleClass("currentTab");
		$("#startPage").toggleClass("hiddenTab");
		$("#startPage").toggleClass("currentTab");
	});
</script>
</html>